---
title: "Producing Figures"
author: "Joe Brown"
date: "2024-06-19"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# Goal

The goal of this script is to produce figures to visualize results of ECS evidence analysis.

```{r, message=FALSE}
library(matilda)
library(tidyverse)
library(MASS)
library(spatstat)
```

# Weighted ensemble

```{r}
weighted_gsat_ensemble <- readRDS("data/weighted_gsat_ensemble.RDS")

eoc_gsat <- lapply(names(weighted_gsat_ensemble), function(df_name) {
  
  data <- weighted_gsat_ensemble[[df_name]]
  
  data$scenario <- df_name
  
  return(data)
  
})


eoc_gsat_df <- do.call(rbind, eoc_gsat)

ggplot(data = eoc_gsat_df) +
  geom_line(aes(x = year, 
                y = value, 
                group = run_number, 
                color = weight_norm, 
                alpha = weight_norm), 
            linewidth= 0.1) +
  scale_color_gradient(low = "lightblue", high = "dodgerblue4", name = "Weights") +
  scale_alpha_continuous(range(c(0,1))) +
  labs(x = "Years", y = "Temp") +
  theme_light() +
  guides(alpha = "none") +
  facet_wrap(~ scenario)
  
ggsave("figures/S2_fig_gsat_ensemble.png",
       device = "png",
       width = 28,
       height = 15,
       units = "cm",
       dpi = "print")
```

# Median temperature and confidence interval

Compute the weighted median and confidence intervals.

```{r}
# median (CI) warming calculation
warming_projection <- eoc_gsat_df %>% 
  group_by(year, scenario) %>% 
  summarize(
    median = weighted.quantile(x = value, w = weight_norm, probs = 0.5), 
    ci_5 = weighted.quantile(x = value, w = weight_norm, probs = 0.05),
    ci_16 = weighted.quantile(x = value, w = weight_norm, probs = 0.16), 
    ci_84 = weighted.quantile(x = value, w = weight_norm, probs = 0.84), 
    ci_95 = weighted.quantile(x = value, w = weight_norm, probs = 0.95),
    ci_66 = weighted.quantile(x = value, w = weight_norm, probs = 0.66), 
    ci_33 = weighted.quantile(x = value, w = weight_norm, probs = 0.33),
    .groups = "drop")

```

Plotting temperature projections:

```{r}
# recoding scenario names for the plot
warming_projection$scenario <- recode_factor(
  warming_projection$scenario,
  No_Historical = "No Historical",
  No_Process = "No Process",
  No_Paleoclimate = "No Paleoclimate",
  Baseline_Emergent_constraints = "Baseline + Emergent constraints")


# Order factor levels for plot facet 
facet_order <- c("Baseline",
                 "No Process",
                 "No Historical",
                 "No Paleoclimate",
                 "Baseline + Emergent constaints")

```

Construct plot: 

```{r}
colors <- c("#003466", "#00a9cf", "#550307", "#EBCC2A", "#F21A00")

temp_projection_plot <- 
  ggplot(data = subset(warming_projection, 
                       year > 2023)) +
  geom_line(aes(x = year, 
                y = median, 
                color = scenario), 
            linewidth = 0.75) +
  scale_color_manual(values = colors) +
  geom_ribbon(aes(x = year, 
                  ymin = ci_5, 
                  ymax = ci_95, 
                  fill = scenario, 
                  color = scenario), 
              alpha = 0.1, 
              linetype = "blank") +
  # geom_ribbon(aes(x = year, 
  #                 ymin = ci_16, 
  #                 ymax = ci_84, 
  #                 fill = scenario, 
  #                 color = scenario), 
  #             alpha = 0.2, 
  #             linetype = "blank") +
  scale_fill_manual(values = colors) +
  labs(x = "Year", 
       y = expression(paste("Future Warming (GSAT) relative to 1995-2014 (", degree, "C)"))) +
  theme_light(base_size = 16) +
  theme(legend.position = "none") +
  facet_wrap(~ scenario)

temp_projection_plot
```

```{r}
historic_tas_subset <- subset(eoc_gsat_df, 
                                year > 1849 &
                                year < 2024)

historic_plot_data <- historic_tas_subset %>% 
  group_by(scenario, year) %>% 
  summarize(
    median = weighted.quantile(value, w = weight_norm, probs = 0.5),
    lower_ci = weighted.quantile(value, w = weight_norm, probs = 0.05),
    upper_ci = weighted.quantile(value, w = weight_norm, probs = 0.95),
    .groups = "drop")

```

```{r}
# recoding scenario names for the plot
historic_plot_data$scenario <- recode_factor(
  historic_plot_data$scenario,
  No_Historical = "No Historical",
  No_Process = "No Process",
  No_Paleoclimate = "No Paleoclimate",
  Baseline_Emergent_constraints = "Baseline + Emergent constraints")


# Order factor levels for plot facet 
facet_order <- c("Baseline",
                 "No Process",
                 "No Historical",
                 "No Paleoclimate",
                 "Baseline + Emergent constaints")

# normalize obs historical temperature
## normalization function
data_normalization <- function(data, reference_years) {
  
  reference_data <- data[data$year %in% reference_years, ]
  
  mean_reference_period <- mean(reference_data$value)
  
  normalize_values <- data$value - mean_reference_period
  
  data$value <- normalize_values
  
  return(data)
  
}


# normalizing historical data to the reference period
reference_historical <- data_normalization(temp_hist, 1995:2014)
```


```{r}
temp_projection_plot +
    geom_point(data = reference_historical, 
             aes(x = year, 
                 y = value), 
             color = "black", 
             size = 0.3) + 
  geom_line(data = historic_plot_data, 
            aes(x = year, 
                y = median), 
            color = "#92397a",
            linewidth = 0.7) +
  geom_ribbon(data = historic_plot_data, 
              aes(x = year, 
                  ymin = lower_ci, 
                  ymax = upper_ci), 
              fill = "#92397a",
              alpha = 0.2)


ggsave("figures/temp_constrained_warming_projections.png",
       device = "png", 
       units = "in",
       width = 10,
       dpi = "print")
```

# Temperature probability

Plotting temperature probabilities for each of the ECS evidence configurations.

Loading data:
```{r}
temp_probability <- readRDS("data/temp_probability_results.RDS")

temp_probability_df <- do.call(rbind, temp_probability)
row.names(temp_probability_df) <- NULL

temp_probability_df <- temp_probability_df %>% 
  complete(scenario, bins) %>% 
  mutate(bins = recode(bins, !!!bins_mapping))

temp_probability_df[is.na(temp_probability_df)] <- 0
```

```{r}
# recoding scenario names for the plot
temp_probability_df$scenario <- recode_factor(
  temp_probability_df$scenario,
  Baseline = "Baseline",
  No_Historical = "No Historical",
  No_Process = "No Process",
  No_Paleoclimate = "No Paleoclimate",
  Baseline_Emergent_constraints = "Baseline + Emergent constraints")

# Order factor levels for plot 
scenario_order <- 
  c("Baseline",
    "No Process",
    "No Historical",
    "No Paleoclimate",
    "Baseline + Emergent constraints")

# order factor levels
temp_probability_df$scenario <- factor(temp_probability_df$scenario, 
                                       levels = scenario_order)
```

The `bang bang bang` operator (`!!!`) expands vectors/lists into individual arguments. Here, this operator allows us to replace the `bins` factor levels according to the vectors in `bins_mapping`. 

Constructing plot:
```{r}
probability_plot <- 
  ggplot(data = temp_probability_df, 
         aes(fill = bins, 
             x = scenario, 
             y = probability)) +
  geom_bar(position = position_fill(reverse = T), 
           stat = "identity", 
           width = 0.6) +
  scale_y_continuous(breaks = seq(0.0, 1.0, 0.1)) +
  scale_fill_manual(
    values = TEMP_PROBABILITY_COLORS,
    labels = bins_mapping,
    name = "Warming") +
  labs(y = "Probability", 
       x = NULL) +
  coord_flip() +
  theme_light(base_size = 16) +
  theme(legend.position = "bottom", 
        axis.text = element_text(size = 14))

probability_plot

```

```{r}
# save the probability plot
ggsave("figures/fig_NUM_temperature_probability_plot.png", 
       probability_plot, 
       device = "png", 
       width = 12,
       height = 8, 
       units = "in", 
       dpi = "print")
```

